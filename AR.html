<!DOCTYPE html>
<head>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>Hello, world!</title>
    <!-- include three.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three/examples/js/loaders/GLTFLoader.js"></script>

    <!-- include jsartoolkit -->
    <script src="jsartoolkit5/artoolkit.min.js"></script>
    <script src="jsartoolkit5/artoolkit.api.js"></script>
    <!-- include threex.artoolkit -->
    <script src="threex/threex-artoolkitsource.js"></script>
    <script src="threex/threex-artoolkitcontext.js"></script>
    <script src="threex/threex-arbasecontrols.js"></script>
    <script src="threex/threex-armarkercontrols.js"></script>
</head>

<body style='margin : 0px; overflow: hidden; font-family: Monospace;'>

<script>

    var scene, camera, renderer, clock, deltaTime, totalTime;

    var arToolkitSource, arToolkitContext;

    var markerRoot1;

    var mesh1;

    initialize();
    animate();

    function initialize()
    {
        scene = new THREE.Scene();

        let ambientLight = new THREE.AmbientLight( 0xcccccc, 1.0 );
        scene.add( ambientLight );

        camera = new THREE.Camera();
        scene.add(camera);

        renderer = new THREE.WebGLRenderer({
            antialias : true,
            alpha: true
        });
        renderer.setClearColor(new THREE.Color('lightgrey'), 0);
        renderer.setSize( 640, 480 );
        renderer.domElement.style.position = 'absolute';
        renderer.domElement.style.top = '0px';
        renderer.domElement.style.left = '0px';
        document.body.appendChild( renderer.domElement );

        clock = new THREE.Clock();
        deltaTime = 0;
        totalTime = 0;

        ////////////////////////////////////////////////////////////
        // setup arToolkitSource
        ////////////////////////////////////////////////////////////

        arToolkitSource = new THREEx.ArToolkitSource({
            sourceType : 'webcam',
        });

        function onResize()
        {
            arToolkitSource.onResize();
            arToolkitSource.copySizeTo(renderer.domElement);
            if ( arToolkitContext.arController !== null )
            {
                arToolkitSource.copySizeTo(arToolkitContext.arController.canvas);
            }
        }

        arToolkitSource.init(function onReady(){
            onResize();
        });

        // handle resize event
        window.addEventListener('resize', function(){
            onResize();
        });

        ////////////////////////////////////////////////////////////
        // setup arToolkitContext
        ////////////////////////////////////////////////////////////

        arToolkitContext = new THREEx.ArToolkitContext({
            cameraParametersUrl: 'camera_para.dat',
            detectionMode: 'mono'
        });

        // Add EventDispatcher to arToolkitContext
        arToolkitContext.dispatchEvent = THREE.EventDispatcher.prototype.dispatchEvent;


        arToolkitContext.init( function onCompleted(){
            camera.projectionMatrix.copy( arToolkitContext.getProjectionMatrix() );
        });

        ////////////////////////////////////////////////////////////
        // setup markerRoots
        ////////////////////////////////////////////////////////////

        markerRoot1 = new THREE.Group();
        scene.add(markerRoot1);
        let markerControls1 = new THREEx.ArMarkerControls(arToolkitContext, markerRoot1, {
            type: 'pattern', patternUrl: "hiro.patt",
        });

        // Add EventDispatcher methods to markerControls1
        markerControls1.dispatchEvent = THREE.EventDispatcher.prototype.dispatchEvent;

        let geometry1 = new THREE.PlaneBufferGeometry(1,1, 4,4);
        let material1 = new THREE.MeshBasicMaterial( { color: 0x0000ff, opacity: 0.5 } );
        mesh1 = new THREE.Mesh( geometry1, material1 );
        mesh1.rotation.x = -Math.PI/2;
        markerRoot1.add( mesh1 );

        const loader = new THREE.GLTFLoader();
        loader.load('tinker_croc.glb', function (gltf) {
            const model = gltf.scene;
            model.scale.set(0.015, 0.015, 0.015);
            model.position.set(0, 0, 0);
            markerRoot1.add(model);
            console.log("Model loaded successfully!", model);
        }, undefined, function (error) {
            console.error('An error occurred loading the GLB model:', error);
        });

    }

    function update()
    {
        if ( arToolkitSource.ready !== false )
            arToolkitContext.update( arToolkitSource.domElement );
    }

    function render()
    {
        renderer.render( scene, camera );
    }

    function animate()
    {
        requestAnimationFrame(animate);
        deltaTime = clock.getDelta();
        totalTime += deltaTime;
        update();
        render();
    }

</script>

</body>
</html>
